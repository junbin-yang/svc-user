/*! 
 Build Time : 1650194964000 */
var e=(e,t,a)=>new Promise(((l,i)=>{var n=e=>{try{o(a.next(e))}catch(t){i(t)}},s=e=>{try{o(a.throw(e))}catch(t){i(t)}},o=e=>e.done?l(e.value):Promise.resolve(e.value).then(n,s);o((a=a.apply(e,t)).next())}));import{g as t,d as a}from"./gin-vue-admin-fileUploadAndDownload.1650194964000.js";import{_ as l,r as i,k as n,b as s,o,c as r,e as d,w as u,g as c,i as p,j as g,X as h,y as m,d as f,t as v,P as w}from"../gva/gin-vue-admin-index.1650194964000.js";import{C as y}from"./gin-vue-admin-index.16501949640009.js";import{f as b}from"./gin-vue-admin-format.1650194964000.js";import"./gin-vue-admin-date.1650194964000.js";import"./gin-vue-admin-dictionary.1650194964000.js";import"./gin-vue-admin-sysDictionary.1650194964000.js";const x=(e,t)=>{var a=new Image;a.setAttribute("crossOrigin","anonymous"),a.onload=function(){var e=document.createElement("canvas");e.width=a.width,e.height=a.height,e.getContext("2d").drawImage(a,0,0,a.width,a.height);var l=e.toDataURL("image/png"),i=document.createElement("a"),n=new MouseEvent("click");i.download=t||"photo",i.href=l,i.dispatchEvent(n)},a.src=e};class z{constructor(e,t,a=1920){this.file=e,this.fileSize=t,this.maxWH=a}compress(){const e=this.file.type,t=this.file.size/1024;return new Promise((a=>{const l=new FileReader;l.readAsDataURL(this.file),l.onload=()=>{const i=document.createElement("canvas"),n=document.createElement("img");n.src=l.result,n.onload=()=>{const l=i.getContext("2d"),s=this.dWH(n.width,n.height,this.maxWH);i.width=s.width,i.height=s.height,l.clearRect(0,0,i.width,i.height),l.drawImage(n,0,0,i.width,i.height);const o=i.toDataURL(e,.9),r=this.fileSizeKB(o);r>this.fileSize&&console.log("图片尺寸太大!"+t+" >> "+r);const d=this.dataURLtoBlob(o,e),u=new File([d],this.file.name);a(u)}}}))}dWH(e,t,a){const l={width:e,height:t};return Math.max(e,t)>a?e>t?(l.width=a,l.height=Math.round(t*(a/e)),l):(l.height=a,l.width=Math.round(e*(a/t)),l):l}fileSizeKB(e){let t=0;return t=Math.round(3*e.split(",")[1].length/4/1024),t}dataURLtoBlob(e,t){const a=atob(e.split(",")[1]);let l=e.split(",")[0].split(":")[1].split(";")[0];const i=new ArrayBuffer(a.length),n=new Uint8Array(i);for(let s=0;s<a.length;s++)n[s]=a.charCodeAt(s);return t&&(l=t),new Blob([i],{type:l,lastModifiedDate:new Date})}}const U=p("压缩上传"),_={name:"UploadImage",methods:{}};var j=l(Object.assign(_,{props:{imageUrl:{type:String,default:""},fileSize:{type:Number,default:2048},maxWH:{type:Number,default:1920}},emits:["on-success"],setup(e,{emit:t}){const a=e,l=i("/"),p=n(),h=e=>{const t="image/jpeg"===e.type,l="image/png"===e.type;if(!t&&!l)return g.error("上传头像图片只能是 jpg或png 格式!"),!1;const i=e.size/1024<a.fileSize;if(!i){return new z(e,a.fileSize,a.maxWH).compress()}return i},m=e=>{const{data:a}=e;a.file&&t("on-success",a.file.url)};return(e,t)=>{const a=s("el-button"),i=s("el-upload");return o(),r("div",null,[d(i,{action:`${l.value}/fileUploadAndDownload/upload`,headers:{"x-token":c(p).token},"show-file-list":!1,"on-success":m,"before-upload":h,multiple:!1},{default:u((()=>[d(a,{size:"small",type:"primary"},{default:u((()=>[U])),_:1})])),_:1},8,["action","headers"])])}}}),[["__scopeId","data-v-15c9badb"]]);const S={class:"gva-table-box"},k={class:"gva-btn-list"},C=p("普通上传"),A=p("下载"),B=p("删除"),D={class:"gva-pagination"},R={name:"Upload"};var E=l(Object.assign(R,{setup(l){const z=i("/"),U=n(),_=i(""),R=i(1),E=i(0),H=i(10),I=i([]),M=e=>{H.value=e,W()},O=e=>{R.value=e,W()},W=()=>e(this,null,(function*(){const e=yield t({page:R.value,pageSize:H.value});0===e.code&&(I.value=e.data.list,E.value=e.data.total,R.value=e.data.page,H.value=e.data.pageSize)}));W();const L=t=>e(this,null,(function*(){w.confirm("此操作将永久文件, 是否继续?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>e(this,null,(function*(){0===(yield a(t)).code&&(g({type:"success",message:"删除成功!"}),1===I.value.length&&R.value>1&&R.value--,W())})))).catch((()=>{g({type:"info",message:"已取消删除"})}))})),P=i(!1),K=e=>{P.value=!0;const t="image/jpeg"===e.type,a="image/png"===e.type,l=e.size/1024/1024<.5;return t||a||(g.error("上传图片只能是 jpg或png 格式!"),P.value=!1),l||(g.error("未压缩未见上传图片大小不能超过 500KB，请使用压缩上传"),P.value=!1),(a||t)&&l},F=e=>{P.value=!1,0===e.code?(g({type:"success",message:"上传成功"}),0===e.code&&W()):g({type:"warning",message:e.msg})},N=()=>{g({type:"error",message:"上传失败"}),P.value=!1};return(e,t)=>{const a=s("el-button"),l=s("el-upload"),i=s("el-table-column"),n=s("el-tag"),g=s("el-table"),w=s("el-pagination"),T=h("loading");return m((o(),r("div",null,[f("div",S,[f("div",k,[d(l,{action:`${z.value}/fileUploadAndDownload/upload`,"before-upload":K,headers:{"x-token":c(U).token},"on-error":N,"on-success":F,"show-file-list":!1,class:"upload-btn"},{default:u((()=>[d(a,{size:"small",type:"primary"},{default:u((()=>[C])),_:1})])),_:1},8,["action","headers"]),d(j,{imageUrl:_.value,"onUpdate:imageUrl":t[0]||(t[0]=e=>_.value=e),"file-size":512,"max-w-h":1080,class:"upload-btn",onOnSuccess:W},null,8,["imageUrl"])]),d(g,{data:I.value},{default:u((()=>[d(i,{align:"left",label:"预览",width:"100"},{default:u((e=>[d(y,{"pic-type":"file","pic-src":e.row.url},null,8,["pic-src"])])),_:1}),d(i,{align:"left",label:"日期",prop:"UpdatedAt",width:"180"},{default:u((e=>[f("div",null,v(c(b)(e.row.UpdatedAt)),1)])),_:1}),d(i,{align:"left",label:"文件名",prop:"name",width:"180"}),d(i,{align:"left",label:"链接",prop:"url","min-width":"300"}),d(i,{align:"left",label:"标签",prop:"tag",width:"100"},{default:u((e=>[d(n,{type:"jpg"===e.row.tag?"primary":"success","disable-transitions":""},{default:u((()=>[p(v(e.row.tag),1)])),_:2},1032,["type"])])),_:1}),d(i,{align:"left",label:"操作",width:"160"},{default:u((e=>[d(a,{size:"small",icon:"download",type:"text",onClick:t=>{var a;(a=e.row).url.indexOf("http://")>-1||a.url.indexOf("https://")>-1?x(a.url,a.name):x(z.value+a.url,a.name)}},{default:u((()=>[A])),_:2},1032,["onClick"]),d(a,{size:"small",icon:"delete",type:"text",onClick:t=>L(e.row)},{default:u((()=>[B])),_:2},1032,["onClick"])])),_:1})])),_:1},8,["data"]),f("div",D,[d(w,{"current-page":R.value,"page-size":H.value,"page-sizes":[10,30,50,100],style:{float:"right",padding:"20px"},total:E.value,layout:"total, sizes, prev, pager, next, jumper",onCurrentChange:O,onSizeChange:M},null,8,["current-page","page-size","total"])])])])),[[T,P.value,void 0,{fullscreen:!0,lock:!0}]])}}}),[["__scopeId","data-v-0bd7e53b"]]);export{E as default};
